<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>todox</title>
  <link rel="stylesheet" href="{{.StylesPath}}">
</head>
<body>
  <div class="app-shell">
    <header class="toolbar" role="banner">
      <button type="button" class="btn btn-icon" id="collapseFilters" aria-label="フィルターを隠す" aria-controls="filter-panel" aria-expanded="true" data-toggle="#filter-panel">×</button>
      <h1 class="app-title">todox</h1>
      <div class="toolbar-presets" id="preset-chips" role="group" aria-label="プリセット">
        <button type="button" class="chip" data-preset="precise">Precise</button>
        <button type="button" class="chip" data-preset="fast">Fast</button>
        <button type="button" class="chip" data-preset="oldest">Oldest first</button>
        <button type="button" class="chip" data-preset="prs">PR重視</button>
        <button type="button" class="chip" data-preset="concise">短く見やすく</button>
        <button type="button" class="chip" data-preset="whitespace">Whitespace厳密</button>
        <button type="button" class="chip" data-preset="baseline">デフォルトに戻す</button>
      </div>
      <details id="options-popover" class="popover">
        <summary class="btn btn-ghost" id="btnOptions">⚙ オプション</summary>
        <div class="popover__content" id="optionsBody" role="group" aria-label="CLI オプションプレビュー">
          <pre class="code" id="cli-preview" aria-live="polite"></pre>
          <button type="button" class="btn btn-secondary" data-copy-target="#cli-preview">コピー</button>
          <p class="muted" id="cli-help"></p>
        </div>
      </details>
    </header>

    <main class="layout" role="main">
      <div class="filters">
        <section id="filter-panel" class="panel">
          <form id="opts" class="options-form" novalidate>
            <fieldset class="section">
              <legend>基本 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                よく使う検索条件です。タグ種類、 blame の基準、著者フィルタ、ソート順を指定できます。
              </div>
              <div class="field-grid">
                <label for="type">マーカー種別
                  <select id="type" name="type">
                    <option value="both">TODO と FIXME</option>
                    <option value="todo">TODO のみ</option>
                    <option value="fixme">FIXME のみ</option>
                  </select>
                </label>
                <label for="mode">著者の定義
                  <select id="mode" name="mode">
                    <option value="last">最終コミット (last)</option>
                    <option value="first">初回コミット (first)</option>
                  </select>
                </label>
                <label for="author">著者フィルタ（拡張正規表現）
                  <input id="author" name="author" type="text" placeholder="Alice|alice@example.com">
                </label>
                <label for="sort-quick">並び替え（簡易）
                  <select id="sort-quick">
                    <option value="">(変更しない)</option>
                    <option value="-age">古い順 (-age)</option>
                    <option value="age">新しい順 (age)</option>
                    <option value="author">著者 (author)</option>
                    <option value="file">ファイル (file)</option>
                  </select>
                </label>
                <label for="sort">並び替え（詳細ビルダー）
                  <input id="sort" name="sort" type="text" placeholder="-age,file">
                </label>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>検出エンジン <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                解析方式や対象言語を制御します。コメント／文字列の扱いもここで切り替えます。
              </div>
              <div class="field-grid">
                <div class="control">
                  <span class="control-label">文字列走査</span>
                  <div class="segmented" role="radiogroup" aria-label="文字列走査">
                    <input type="radio" id="scan-comments" name="string_scan" value="comments_only" checked>
                    <label for="scan-comments">コメントのみ</label>
                    <input type="radio" id="scan-mixed" name="string_scan" value="include_strings">
                    <label for="scan-mixed">コメント＋文字列</label>
                    <input type="radio" id="scan-none" name="string_scan" value="no_strings">
                    <label for="scan-none">文字列なし</label>
                  </div>
                </div>
                <label for="detect">検出エンジン
                  <select id="detect" name="detect">
                    <option value="auto">auto (自動)</option>
                    <option value="parse">parse</option>
                    <option value="regex">regex</option>
                  </select>
                </label>
                <label for="detect_langs">対象言語（CSV／スペース区切り）
                  <input id="detect_langs" name="detect_langs" type="text" data-tokenize placeholder="go,js,ts,py">
                </label>
                <label for="tags">タグ上書き（CSV）
                  <input id="tags" name="tags" type="text" placeholder="TODO,FIXME,NOTE">
                </label>
                <label for="max_file_bytes">最大ファイルサイズ（バイト）
                  <input id="max_file_bytes" name="max_file_bytes" type="number" min="0" step="1" placeholder="0">
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="no_prefilter" name="no_prefilter" value="1">
                  git grep プリフィルタを無効化
                </label>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>パス・除外 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                スキャン対象／除外パスを細かく指定できます。改行またはカンマで複数入力できます。
              </div>
              <div class="field-grid">
                <label for="path">対象パス
                  <textarea id="path" name="path" rows="2" data-multi placeholder="cmd,internal"></textarea>
                </label>
                <label for="exclude">除外パス
                  <textarea id="exclude" name="exclude" rows="2" data-multi placeholder="vendor/**,node_modules/**"></textarea>
                </label>
                <label for="path_regex">パス正規表現
                  <textarea id="path_regex" name="path_regex" rows="2" data-multi placeholder=".*\\.go$"></textarea>
                </label>
                <label class="checkbox">
                  <input type="checkbox" id="exclude_typical" name="exclude_typical" value="1">
                  定番ディレクトリを除外
                </label>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>列と付加情報 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                表示列と、追加のメタデータ取得を制御します。`fields` に URL／PR 列を含めると自動的に対応フラグが有効になります。
              </div>
              <div class="field-grid">
                <label for="fields">表示列（Ctrl/Cmd + クリックで複数選択）
                  <select id="fields" name="fields" multiple size="8">
                    <option value="type">type</option>
                    <option value="tag">tag</option>
                    <option value="kind">kind</option>
                    <option value="lang">lang</option>
                    <option value="author">author</option>
                    <option value="email">email</option>
                    <option value="date">date</option>
                    <option value="age">age</option>
                    <option value="commit">commit</option>
                    <option value="location">location</option>
                    <option value="text">text</option>
                    <option value="span">span</option>
                    <option value="comment">comment</option>
                    <option value="message">message</option>
                    <option value="url">url</option>
                    <option value="commit_url">commit_url</option>
                    <option value="pr">pr</option>
                    <option value="prs">prs</option>
                    <option value="pr_urls">pr_urls</option>
                  </select>
                </label>
                <div class="checkbox-grid">
                  <label class="checkbox"><input type="checkbox" name="with_comment" value="1"> コメント列</label>
                  <label class="checkbox"><input type="checkbox" name="with_message" value="1"> コミットメッセージ</label>
                  <label class="checkbox"><input type="checkbox" name="with_age" value="1"> 経過日数</label>
                  <label class="checkbox"><input type="checkbox" name="with_commit_link" value="1"> コミットリンク</label>
                  <label class="checkbox"><input type="checkbox" id="with_pr_links" name="with_pr_links" value="1"> PRリンク</label>
                </div>
                <div class="subsection" id="pr-options" hidden>
                  <label for="pr_state">PR state
                    <select id="pr_state" name="pr_state">
                      <option value="">(any)</option>
                      <option value="open">open</option>
                      <option value="merged">merged</option>
                      <option value="closed">closed</option>
                      <option value="all">all</option>
                    </select>
                  </label>
                  <label for="pr_limit">PR limit
                    <input id="pr_limit" name="pr_limit" type="number" min="1" max="20" value="3">
                  </label>
                  <label for="pr_prefer">PR prefer
                    <select id="pr_prefer" name="pr_prefer">
                      <option value="">(none)</option>
                      <option value="open">open</option>
                      <option value="merged">merged</option>
                      <option value="closed">closed</option>
                      <option value="none">none</option>
                    </select>
                  </label>
                </div>
                <p class="note" id="field-auto-note">`url` や `pr` を選ぶと対応する `with_*` フラグが自動で有効になります。</p>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>表示長の制御 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                表示する文字数を制限します。0 で無制限です。
              </div>
              <div class="field-grid">
                <label for="truncate">truncate
                  <input id="truncate" name="truncate" type="number" min="0" placeholder="120">
                </label>
                <label for="truncate_comment">truncate_comment
                  <input id="truncate_comment" name="truncate_comment" type="number" min="0">
                </label>
                <label for="truncate_message">truncate_message
                  <input id="truncate_message" name="truncate_message" type="number" min="0">
                </label>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>実行・パフォーマンス <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
              <div class="help-text" hidden>
                スキャン対象リポジトリや並列数を設定します。空白のみの差分を無視するかもここで選べます。
              </div>
              <div class="field-grid">
                <label for="repo">リポジトリ
                  <input id="repo" name="repo" type="text" placeholder=".">
                </label>
                <label for="ignore_ws" class="select">空白差分の扱い
                  <select id="ignore_ws" name="ignore_ws">
                    <option value="1">空白のみの変更を無視</option>
                    <option value="0">空白差分も最新扱い</option>
                  </select>
                </label>
                <label for="jobs">jobs
                  <input id="jobs" name="jobs" type="number" min="1" max="64" placeholder="">
                </label>
              </div>
            </fieldset>

            <fieldset class="section">
              <legend>プリセット</legend>
              <p class="note">プリセットを選ぶとフォームが更新されます。上部チップと同じ内容です。</p>
            </fieldset>
          </form>
        </section>
      </div>

      <section class="results" aria-live="polite">
        <div id="error-banner" class="banner is-hidden" role="alert">
          <div class="banner__body">
            <span id="error-message"></span>
          </div>
          <button type="button" class="btn btn-icon" id="error-close" aria-label="エラーを閉じる">×</button>
        </div>

        <div id="progress" class="progress-panel is-hidden" role="status" aria-live="polite">
          <div class="progress-head">
            <progress id="progress-meter" value="0" max="1"></progress>
            <div class="progress-meta">
              <span id="progress-stage" class="progress-stage">scan</span>
              <span id="progress-eta" class="progress-stat"></span>
              <span id="progress-rate" class="progress-stat"></span>
              <span id="progress-elapsed" class="progress-stat"></span>
            </div>
          </div>
          <div class="progress-stages" role="list">
            <span id="st-scan" class="stage" role="listitem">scan</span>
            <span id="st-attr" class="stage" role="listitem">attr</span>
            <span id="st-pr" class="stage" role="listitem">pr</span>
          </div>
          <div class="progress-footer">
            <span id="progress-stats" class="progress-stat"></span>
            <button type="button" class="btn" id="progress-cancel">キャンセル</button>
          </div>
        </div>

        <div class="results-toolbar">
          <div class="results-count" id="result-count">結果: 0 件</div>
          <div class="results-actions">
            <button type="button" class="btn" id="export-json" disabled>JSONエクスポート</button>
            <button type="button" class="btn" id="export-tsv" disabled>TSVエクスポート</button>
          </div>
        </div>

        <div id="result-errors" class="muted"></div>
        <div id="result-table" class="table-shell" role="region" aria-live="polite"></div>
      </section>
    </main>

    <footer class="actionbar" role="contentinfo">
      <div class="action-buttons">
        <button type="submit" form="opts" class="btn btn-primary">スキャン</button>
        <button type="button" class="btn" id="cancel-scan">キャンセル</button>
        <button type="reset" form="opts" class="btn" id="reset-form">リセット</button>
      </div>
      <div class="share-fields">
        <div class="share-field">
          <label for="cli-command">CLI コマンド</label>
          <textarea id="cli-command" rows="2" readonly></textarea>
          <button type="button" class="btn btn-icon" data-copy-target="#cli-command" aria-label="CLI コマンドをコピー">⧉</button>
        </div>
        <div class="share-field">
          <label for="share-url">共有URL</label>
          <input id="share-url" type="text" readonly>
          <button type="button" class="btn btn-icon" data-copy-target="#share-url" aria-label="共有URLをコピー">⧉</button>
        </div>
      </div>
    </footer>
  </div>

  <script type="module" src="{{.ScriptPath}}"></script>
</body>
</html>
