<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>todox</title>
  <link rel="stylesheet" href="{{.StylesPath}}">
</head>
<body>
  <div class="app-shell">
    <aside class="options-panel" id="options-panel" data-open>
      <div class="panel-header">
        <h1>todox</h1>
        <button type="button" class="panel-close" id="panel-close" aria-label="オプションを閉じる">×</button>
      </div>
      <div class="panel-body">
        <div class="preset-chips" role="group" aria-label="プリセット">
          <span class="preset-title">プリセット</span>
          <div class="chip-wrap" id="preset-chips">
            <button type="button" class="chip" data-preset="precise">Precise</button>
            <button type="button" class="chip" data-preset="fast">Fast</button>
            <button type="button" class="chip" data-preset="oldest">Oldest first</button>
            <button type="button" class="chip" data-preset="prs">PR重視</button>
            <button type="button" class="chip" data-preset="concise">短く見やすく</button>
            <button type="button" class="chip" data-preset="whitespace">Whitespace厳密</button>
            <button type="button" class="chip" data-preset="baseline">デフォルトに戻す</button>
          </div>
        </div>
        <form id="opts" class="options-form">
          <fieldset class="section">
            <legend>基本 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              よく使う検索条件です。タグ種類、 blame の基準、著者フィルタ、ソート順を指定できます。
            </div>
            <div class="field-grid">
              <label for="type">マーカー種別
                <select id="type" name="type">
                  <option value="both">TODO と FIXME</option>
                  <option value="todo">TODO のみ</option>
                  <option value="fixme">FIXME のみ</option>
                </select>
              </label>
              <label for="mode">著者の定義
                <select id="mode" name="mode">
                  <option value="last">最終コミット (last)</option>
                  <option value="first">初回コミット (first)</option>
                </select>
              </label>
              <label for="author">著者フィルタ（拡張正規表現）
                <input id="author" name="author" type="text" placeholder="Alice|alice@example.com">
              </label>
              <label for="sort-quick">並び替え（簡易）
                <select id="sort-quick">
                  <option value="">(変更しない)</option>
                  <option value="-age">古い順 (-age)</option>
                  <option value="age">新しい順 (age)</option>
                  <option value="author">著者 (author)</option>
                  <option value="file">ファイル (file)</option>
                </select>
              </label>
              <label for="sort">並び替え（詳細ビルダー）
                <input id="sort" name="sort" type="text" placeholder="-age,file">
              </label>
            </div>
          </fieldset>

          <fieldset class="section">
            <legend>検出エンジン <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              解析方式や対象言語を制御します。コメント／文字列の扱いもここで切り替えます。
            </div>
            <div class="field-grid">
              <div class="control">
                <span class="control-label">文字列走査</span>
                <div class="segmented" role="radiogroup" aria-label="文字列走査">
                  <input type="radio" id="scan-comments" name="string_scan" value="comments_only" checked>
                  <label for="scan-comments">コメントのみ</label>
                  <input type="radio" id="scan-mixed" name="string_scan" value="include_strings">
                  <label for="scan-mixed">コメント＋文字列</label>
                  <input type="radio" id="scan-none" name="string_scan" value="no_strings">
                  <label for="scan-none">文字列なし</label>
                </div>
              </div>
              <label for="detect">検出エンジン
                <select id="detect" name="detect">
                  <option value="auto">auto (自動)</option>
                  <option value="parse">parse</option>
                  <option value="regex">regex</option>
                </select>
              </label>
              <label for="detect_langs">対象言語（CSV／スペース区切り）
                <input id="detect_langs" name="detect_langs" type="text" data-tokenize placeholder="go,js,ts,py">
              </label>
              <label for="tags">タグ上書き（CSV）
                <input id="tags" name="tags" type="text" placeholder="TODO,FIXME,NOTE">
              </label>
              <label for="max_file_bytes">最大ファイルサイズ（バイト）
                <input id="max_file_bytes" name="max_file_bytes" type="number" min="0" step="1" placeholder="0">
              </label>
              <label class="checkbox">
                <input type="checkbox" id="no_prefilter" name="no_prefilter" value="1">
                git grep プリフィルタを無効化
              </label>
            </div>
          </fieldset>

          <fieldset class="section">
            <legend>パス・除外 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              スキャン対象／除外パスを細かく指定できます。改行またはカンマで複数入力できます。
            </div>
            <div class="field-grid">
              <label for="path">対象パス
                <textarea id="path" name="path" rows="2" data-multi placeholder="cmd,internal"></textarea>
              </label>
              <label for="exclude">除外パス
                <textarea id="exclude" name="exclude" rows="2" data-multi placeholder="vendor/**,node_modules/**"></textarea>
              </label>
              <label for="path_regex">パス正規表現
                <textarea id="path_regex" name="path_regex" rows="2" data-multi placeholder=".*\\.go$"></textarea>
              </label>
              <label class="checkbox">
                <input type="checkbox" id="exclude_typical" name="exclude_typical" value="1">
                定番ディレクトリを除外
              </label>
            </div>
          </fieldset>

          <fieldset class="section">
            <legend>列と付加情報 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              表示列と、追加のメタデータ取得を制御します。`fields` に URL／PR 列を含めると自動的に対応フラグが有効になります。
            </div>
            <div class="field-grid">
              <label for="fields">表示列（Ctrl/Cmd + クリックで複数選択）
                <select id="fields" name="fields" multiple size="8">
                  <option value="type">type</option>
                  <option value="tag">tag</option>
                  <option value="kind">kind</option>
                  <option value="lang">lang</option>
                  <option value="author">author</option>
                  <option value="email">email</option>
                  <option value="date">date</option>
                  <option value="age">age</option>
                  <option value="commit">commit</option>
                  <option value="location">location</option>
                  <option value="text">text</option>
                  <option value="span">span</option>
                  <option value="comment">comment</option>
                  <option value="message">message</option>
                  <option value="url">url</option>
                  <option value="commit_url">commit_url</option>
                  <option value="pr">pr</option>
                  <option value="prs">prs</option>
                  <option value="pr_urls">pr_urls</option>
                </select>
              </label>
              <div class="checkbox-group">
                <label class="checkbox"><input type="checkbox" name="with_comment" value="1"> コメント列</label>
                <label class="checkbox"><input type="checkbox" name="with_message" value="1"> コミットメッセージ</label>
                <label class="checkbox"><input type="checkbox" name="with_age" value="1"> 経過日数</label>
                <label class="checkbox"><input type="checkbox" name="with_commit_link" value="1"> コミットURL</label>
                <label class="checkbox"><input type="checkbox" id="with_pr_links" name="with_pr_links" value="1"> PRリンク</label>
              </div>
              <p class="inline-note" id="field-auto-note" hidden>URL/PR列を選択したため必要なフラグを自動で有効化しました。</p>
              <div id="pr-options" class="pr-options" hidden>
                <label for="pr_state">PR state
                  <select id="pr_state" name="pr_state">
                    <option value="">(既定)</option>
                    <option value="open">open</option>
                    <option value="merged">merged</option>
                    <option value="closed">closed</option>
                    <option value="all">all</option>
                  </select>
                </label>
                <label for="pr_limit">PR limit
                  <input id="pr_limit" name="pr_limit" type="number" min="1" max="20" value="3">
                </label>
                <label for="pr_prefer">PR prefer
                  <select id="pr_prefer" name="pr_prefer">
                    <option value="">(指定なし)</option>
                    <option value="open">open</option>
                    <option value="merged">merged</option>
                    <option value="closed">closed</option>
                    <option value="none">none</option>
                  </select>
                </label>
                <p class="inline-note">GitHub 認証が必要な場合は `gh auth login` または `GITHUB_TOKEN` を設定してください。</p>
              </div>
            </div>
          </fieldset>

          <fieldset class="section">
            <legend>表示長の制御 <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              COMMENT／MESSAGE の表示幅を調整します。0 で無制限です。
            </div>
            <div class="range-grid">
              <div class="range-pair" data-target="truncate">
                <label for="truncate">全体トランケート (truncate)</label>
                <input type="range" id="truncate-range" min="0" max="240" step="10">
                <input type="number" id="truncate" name="truncate" min="0" step="1" placeholder="120">
              </div>
              <div class="range-pair" data-target="truncate_comment">
                <label for="truncate_comment">コメント幅 (truncate_comment)</label>
                <input type="range" id="truncate_comment-range" min="0" max="240" step="10">
                <input type="number" id="truncate_comment" name="truncate_comment" min="0" step="1">
              </div>
              <div class="range-pair" data-target="truncate_message">
                <label for="truncate_message">メッセージ幅 (truncate_message)</label>
                <input type="range" id="truncate_message-range" min="0" max="240" step="10">
                <input type="number" id="truncate_message" name="truncate_message" min="0" step="1">
              </div>
            </div>
          </fieldset>

          <fieldset class="section">
            <legend>実行・パフォーマンス <button type="button" class="help-toggle" aria-expanded="false">?</button></legend>
            <div class="help-text" hidden>
              リポジトリや空白差分、並列度などの実行条件を設定します。
            </div>
            <div class="field-grid">
              <label for="repo">リポジトリパス
                <input id="repo" name="repo" type="text" placeholder=".">
              </label>
              <label for="ignore_ws">空白差分の扱い
                <select id="ignore_ws" name="ignore_ws">
                  <option value="1">空白のみの変更を無視 (既定)</option>
                  <option value="0">空白のみの変更も最新扱い</option>
                </select>
              </label>
              <label for="jobs">jobs (1–64、空欄=自動)
                <input id="jobs" name="jobs" type="number" min="1" max="64" step="1" placeholder="">
              </label>
            </div>
          </fieldset>

          <div class="form-actions">
            <button type="submit" class="primary">スキャン</button>
            <button type="button" id="cancel-scan">キャンセル</button>
            <button type="button" id="reset-form">リセット</button>
          </div>
        </form>
      </div>
    </aside>

    <main class="main-area">
      <header class="main-header">
        <button type="button" class="panel-open" id="panel-open">⚙️ オプション</button>
        <div class="share-box">
          <div class="share-line">
            <label for="cli-command">CLI 等価コマンド</label>
            <textarea id="cli-command" class="share-text" rows="1" readonly spellcheck="false"></textarea>
            <button type="button" class="copy-btn" data-copy-target="#cli-command">コピー</button>
          </div>
          <div class="share-line">
            <label for="share-url">共有URL</label>
            <input id="share-url" class="share-text" type="text" readonly spellcheck="false">
            <button type="button" class="copy-btn" data-copy-target="#share-url">コピー</button>
          </div>
        </div>
      </header>

      <div id="error-banner" class="error-banner" role="alert" aria-live="assertive">
        <span id="error-message"></span>
        <button type="button" id="error-close" aria-label="閉じる">×</button>
      </div>

      <section id="progress" class="progress-wrap" aria-live="polite" hidden>
        <div class="progress-header">
          <div class="progress-heading">
            <strong id="progress-stage">scan</strong>
            <span id="progress-stats" class="muted"></span>
          </div>
          <button type="button" id="progress-cancel" class="linklike">キャンセル</button>
        </div>
        <ol class="stepper" aria-label="Stages">
          <li id="st-scan" class="current">scan</li>
          <li id="st-attr">attr</li>
          <li id="st-pr">pr</li>
        </ol>
        <div id="progressbar" class="progressbar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Stage progress">
          <div id="progressbar-inner" style="width:0%"></div>
        </div>
        <div class="progress-footer muted">
          <span id="progress-eta">ETA: —</span>
          <span id="progress-rate">Rate: —</span>
          <span id="progress-elapsed">Elapsed: —</span>
        </div>
      </section>

      <section class="result-controls">
        <div class="result-info">
          <span id="result-count">結果: 0 件</span>
          <span id="result-errors" class="muted" hidden></span>
        </div>
        <div class="result-actions">
          <button type="button" id="export-json" disabled>JSON を保存</button>
          <button type="button" id="export-tsv" disabled>TSV を保存</button>
        </div>
      </section>

      <div id="result-table" class="result-table"></div>
    </main>
  </div>

  <script src="{{.ScriptPath}}" defer></script>
</body>
</html>
